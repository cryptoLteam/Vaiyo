<%
# BigBlueButton open source conferencing system - http://www.bigbluebutton.org/.
# Copyright (c) 2018 BigBlueButton Inc. and by respective authors (see below).
# This program is free software; you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free Software
# Foundation; either version 3.0 of the License, or (at your option) any later
# version.
#
# BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
# You should have received a copy of the GNU Lesser General Public License along
# with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
%>

<% if !@user.errors.empty? %>
   <div class = "alert alert-error">
      <% @user.errors.full_messages.each do |msg| %>
        <div class="alert alert-danger alert-dismissible text-center mb-0">
          <button type="button" class="close" data-dismiss="alert">Ã—</button>
          <%= msg %>
        </div>
      <% end %>
   </div>
<% end %>

<% readonly = !can_edit_user?(@user, current_user) %>

<%= form_for @user, url: update_user_path, method: :post do |f|  %>
  <%= hidden_field_tag :setting, "account" %>
  <div class="form-group">
    <div class="row">
      <div class="col-sm-6 mb-4">
        <%= f.label :name, t("settings.account.fullname"), class: "form-label" %>
        <div class="input-icon">
          <%= f.text_field :name, class: "form-control #{form_is_invalid?(@user, :name)}", placeholder: t("settings.account.fullname"), readonly: readonly %>
        </div>
      </div>

      <div class="col-sm-6 mb-4">
        <%= f.label :waddress, t("waddress"), class: "form-label" %>
        <!-- <div class="input-icon">
          <%= f.text_field :waddress, class: "form-control #{form_is_invalid?(@user, :waddress)}", placeholder: t("waddress"), readonly: readonly %>
        </div> -->

        <div class="input-group">
          <%= f.text_field :waddress, id: "txtwaddress1", class: "form-control #{form_is_invalid?(@user, :waddress)}", placeholder: t("waddress"), readonly: true %>
          <div class="input-group-append">
            <button type="button" class="btn" data-toggle="modal" data-target="#exampleModalCenter"><i class="fa fa-bars"></i></button>
          </div>
        </div>
      </div>
    </div>
    
    <% if false %>
      <%= f.label :provider, t("settings.account.provider"), class: "form-label" %>
      <% if @user.provider === 'greenlight' %>
        <%= f.text_field :provider, class: "form-control", readonly: "", value: 'Vaiyo' %>
      <% else %>
        <%= f.text_field :provider, class: "form-control", readonly: "" %>
      <% end %>
    <% end %>

    <br>
    <div class="row">
      <div class="col-sm-6 mb-4">
        <%= f.label :email, t("email"), class: "form-label" %>
        <div class="input-icon">
          <%= f.email_field :email, class: "form-control #{form_is_invalid?(@user, :email)}", placeholder: t("email"), readonly: readonly %>
        </div>
      </div>

      <div class="col-md-6 mb-4 select-user-lang">
        <%= f.label :language, t("settings.account.language"), class: "form-label" %>
        <select id="language-dropdown" class="selectpicker show-tick w-100">
          <% language_options.each do |lang| %>
            <option value="<%=lang[1]%>" <%= 'selected' if lang[1] == @user.language %>><%= lang[0] %></option>
          <% end %>
        </select>
        <%= f.hidden_field :language, id: "user_language", value: @user.language %>
      </div>
    </div>

    <div class="row mt-5">
      <div class="col-md-6">
        <%= f.label :roles, t("settings.account.roles"), class: "form-label" %>
        <% if current_user.role.get_permission("can_manage_users") %>
          <select id="role-dropdown" class="selectpicker show-tick w-100" >
            <% role_options.each do |role| %>
              <option value="<%=role.id%>"><%= translated_role_name(role) %></option>
            <% end %>
          </select>

          <%= f.hidden_field :role_id, id: "user_role_id", value: @user.role.id %>
        <% else %>
          <span style="<%= "background-color: #{role_colour(@user.role)};border-color: #{role_colour(@user.role)};" %>" class="tag custom-role-tag">
            <%= translated_role_name(@user.role) %>
          </span>
        <% end %>
      </div>
      <div class="col-md-6">
        <%= f.label :affiliate_link, t("affiliate_link"), class: "form-label" %>
        <div class="input-icon">
          <div class="input-group">
            <%= f.text_field :affiliate_link, class: "form-control #{form_is_invalid?(@user, :email)}", value: request.base_url + '/' + @user.waddress[0..8].slice!(2, 8), :disabled => true %>
            <div class="input-group-append">
              <button type="button" class="btn btn-copy" title="Click To Copy" data-toggle="tooltip" data-link="<%= request.base_url + '/' + @user.waddress[0..8].slice!(2, 8) %>"><i class="fa fa-clone"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%= f.label :image, t("settings.account.image"), class: "form-label mt-5" %>
    <div class="row">
      <div class="col-5 col-sm-2">
        <% if @user.image.blank? %>
          <span class="avatar avatar-xxl mr-5 mt-2 bg-primary"><%= @user.name.first %></span>
        <% else %>
          <%= image_tag(@user.image.url, class: "avatar avatar-xxl mr-5 mt-2") %>
        <% end %>
      </div>
      <div class="col-7 col-sm-10 mt-5">
        <%= f.file_field :image %>
      </div>
    </div>
  </div>
  
  <div class="card-footer">
    <%= f.submit t("update"), class: "btn btn-primary float-right ml-4" %>

    <% if can_reset_password %>
      <%= link_to t("settings.account.reset_password"), admin_reset_path(user_uid: @user.uid), class: "btn btn-primary float-right" %>
    <% end %>
  </div>

  <div style="display:none">
    <%= f.text_field :wtype, id: "wtype1", class: "form-control #{form_is_invalid?(@user, :wtype)}", placeholder: t("waddress"), readonly: true %>
  </div>
  
  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">
                Connect to a wallet
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <button type="button" class="btn btn-secondary w-100" onclick="connectWithWallet('metamask', 'profile')" data-dismiss="modal">
                  <span>Metamask</span>
                </button>
            </div>
          <!--  <div class="form-group">
                <button type="button" class="btn btn-secondary w-100" onclick="connectWithWallet('trustwallet', 'profile')" data-dismiss="modal">TrustWallet</button>
            </div> -->
          <!--  <div class="form-group">
                <button type="button" class="btn btn-secondary w-100 disabled"" data-dismiss="modal">MathWallet</button>
            </div> -->
          <!--  <div class="form-group">
                <button type="button" class="btn btn-secondary w-100" onclick="connectWithWallet('tokenpocket', 'profile')" data-dismiss="modal">TokenPocket</button>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-secondary w-100" onclick="connectWithWallet('walletconnect', 'profile')" data-dismiss="modal">WalletConnect</button>
            </div> -->
            <div class="form-group">
                <button type="button" class="btn btn-secondary w-100" onclick="connectWithWallet('binance', 'profile')" data-dismiss="modal">Binance Chain Wallet</button>
            </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary w-100" data-dismiss="modal">Close</button>
          </div>
      </div>
  </div>

<% end %>

<script>
  jQuery(document).ready(function () { 
    jQuery(document).on('click', '.btn-copy', function (e) {
      navigator.clipboard.writeText(jQuery(this).attr('data-link'));
      jQuery(this).attr("data-original-title", "Copied").tooltip('show');
    });

    jQuery('.btn-copy').on('hidden.bs.tooltip', function () {
      jQuery('.copy').attr("data-original-title", "Click To Copy");
    })
  })
</script>
